name: Smart CI - Change Detection

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      shared: ${{ steps.changes.outputs.shared }}
      backend: ${{ steps.changes.outputs.backend }}
      web: ${{ steps.changes.outputs.web }}
      mobile: ${{ steps.changes.outputs.mobile }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check changed files
        id: changes
        run: |
          # Get changed files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          else
            CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check if shared changed
          if echo "$CHANGED_FILES" | grep -q "^shared/"; then
            echo "shared=true" >> $GITHUB_OUTPUT
            echo "üîÑ Shared library changed"
          else
            echo "shared=false" >> $GITHUB_OUTPUT
          fi

          # Check if backend changed (includes shared changes)
          if echo "$CHANGED_FILES" | grep -qE "^(backend/|shared/)"; then
            echo "backend=true" >> $GITHUB_OUTPUT
            echo "üîÑ Backend changed"
          else
            echo "backend=false" >> $GITHUB_OUTPUT
          fi

          # Check if web changed (includes shared changes)
          if echo "$CHANGED_FILES" | grep -qE "^(web/|shared/)"; then
            echo "web=true" >> $GITHUB_OUTPUT
            echo "üîÑ Web changed"
          else
            echo "web=false" >> $GITHUB_OUTPUT
          fi

          # Check if mobile changed (includes shared changes)
          if echo "$CHANGED_FILES" | grep -qE "^(mobile/|shared/)"; then
            echo "mobile=true" >> $GITHUB_OUTPUT
            echo "üîÑ Mobile changed"
          else
            echo "mobile=false" >> $GITHUB_OUTPUT
          fi

  setup:
    name: Setup & Install
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Cache node modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            backend/node_modules
            web/node_modules
            mobile/node_modules
            shared/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm ci

  shared:
    name: üì¶ Shared Library
    needs: [changes, setup]
    if: needs.changes.outputs.shared == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Restore node modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            backend/node_modules
            web/node_modules
            mobile/node_modules
            shared/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}

      - name: Build shared
        run: npm run build:shared

      - name: Cache shared build
        uses: actions/cache@v4
        with:
          path: shared/dist
          key: shared-dist-${{ github.sha }}

  backend:
    name: üöÄ Backend
    needs: [changes, setup, shared]
    if: |
      always() && 
      needs.changes.outputs.backend == 'true' &&
      (needs.shared.result == 'success' || needs.shared.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Restore node modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            backend/node_modules
            web/node_modules
            mobile/node_modules
            shared/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}

      - name: Restore shared build
        if: needs.changes.outputs.shared == 'true'
        uses: actions/cache@v4
        with:
          path: shared/dist
          key: shared-dist-${{ github.sha }}

      - name: Lint
        run: npm run lint:backend

      - name: Test
        run: npm --workspace backend run test -- --passWithNoTests

      - name: Build
        run: npm run build:backend

  web:
    name: üåê Web Frontend
    needs: [changes, setup, shared]
    if: |
      always() && 
      needs.changes.outputs.web == 'true' &&
      (needs.shared.result == 'success' || needs.shared.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Restore node modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            backend/node_modules
            web/node_modules
            mobile/node_modules
            shared/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}

      - name: Restore shared build
        if: needs.changes.outputs.shared == 'true'
        uses: actions/cache@v4
        with:
          path: shared/dist
          key: shared-dist-${{ github.sha }}

      - name: Lint
        run: npm run lint:web

      - name: Build
        run: npm run build:web

  mobile:
    name: üì± Mobile App
    needs: [changes, setup, shared]
    if: |
      always() && 
      needs.changes.outputs.mobile == 'true' &&
      (needs.shared.result == 'success' || needs.shared.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Restore node modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            backend/node_modules
            web/node_modules
            mobile/node_modules
            shared/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}

      - name: Restore shared build
        if: needs.changes.outputs.shared == 'true'
        uses: actions/cache@v4
        with:
          path: shared/dist
          key: shared-dist-${{ github.sha }}

      - name: Lint
        run: npm run lint:mobile

  summary:
    name: üìä CI Summary
    needs: [changes, shared, backend, web, mobile]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "# üéØ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Changes Detected" >> $GITHUB_STEP_SUMMARY
          echo "- Shared: ${{ needs.changes.outputs.shared }}" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ${{ needs.changes.outputs.backend }}" >> $GITHUB_STEP_SUMMARY
          echo "- Web: ${{ needs.changes.outputs.web }}" >> $GITHUB_STEP_SUMMARY
          echo "- Mobile: ${{ needs.changes.outputs.mobile }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "- üì¶ Shared: ${{ needs.shared.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- üöÄ Backend: ${{ needs.backend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- üåê Web: ${{ needs.web.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- üì± Mobile: ${{ needs.mobile.result }}" >> $GITHUB_STEP_SUMMARY

      - name: Check overall status
        run: |
          if [ "${{ needs.backend.result }}" == "failure" ] || \
             [ "${{ needs.web.result }}" == "failure" ] || \
             [ "${{ needs.mobile.result }}" == "failure" ] || \
             [ "${{ needs.shared.result }}" == "failure" ]; then
            echo "‚ùå CI Pipeline Failed"
            exit 1
          fi
          echo "‚úÖ CI Pipeline Passed"
