# ============================================
# Smart Forecast - Release Workflow
# ============================================
# Workflow nÃ y tá»± Ä‘á»™ng build vÃ  release khi táº¡o Git tag dáº¡ng "v*"
#
# Output:
#   - backend-dist.zip: NestJS backend (dist + package.json + node_modules)
#   - web-dist.zip: Next.js web app (standalone build)
#   - smart-forecast-*.apk: Android APK tá»« EAS Build
#
# GitHub Secrets cáº§n thiáº¿t:
#   - EXPO_TOKEN (báº¯t buá»™c): Token tá»« expo.dev Ä‘á»ƒ build mobile
#   - NEXT_PUBLIC_API_URL (optional): Production API URL cho web
#   - NEXT_PUBLIC_MINIO_URL (optional): Production MinIO URL cho web
#
# LÆ°u Ã½: Backend khÃ´ng cáº§n secrets khi build - ngÆ°á»i dÃ¹ng sáº½ tá»±
# táº¡o file .env khi deploy vá»›i cÃ¡c biáº¿n nhÆ° DATABASE_URL, JWT_SECRET, etc.
# ============================================

name: Release

on:
  push:
    tags:
      - 'v*'

# Permissions cáº§n thiáº¿t Ä‘á»ƒ táº¡o release vÃ  upload artifacts
permissions:
  contents: write

# NgÄƒn cháº·n multiple releases cháº¡y Ä‘á»“ng thá»i
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  # ============================================
  # Job 1: Build Shared Package
  # ============================================
  # Shared package chá»©a types vÃ  constants dÃ¹ng chung
  # Cáº§n build trÆ°á»›c vÃ¬ backend vÃ  web depend on nÃ³
  build-shared:
    name: ğŸ“¦ Build Shared Package
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”¨ Build shared package
        run: pnpm --filter shared build

      - name: ğŸ’¾ Cache shared build output
        uses: actions/cache/save@v4
        with:
          path: |
            shared/dist
            node_modules
            backend/node_modules
            web/node_modules
            mobile/node_modules
            docs-site/node_modules
          key: shared-build-${{ github.sha }}

  # ============================================
  # Job 2: Build Backend (NestJS)
  # ============================================
  # Build NestJS backend vÃ  Ä‘Ã³ng gÃ³i vá»›i production dependencies
  build-backend:
    name: ğŸ–¥ï¸ Build Backend
    runs-on: ubuntu-latest
    needs: build-shared
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Restore shared build cache
        uses: actions/cache/restore@v4
        with:
          path: |
            shared/dist
            node_modules
            backend/node_modules
            web/node_modules
            mobile/node_modules
            docs-site/node_modules
          key: shared-build-${{ github.sha }}

      - name: ğŸ”¨ Build backend
        run: pnpm --filter backend build

      - name: ğŸ“¦ Create production deployment package
        run: |
          # Táº¡o thÆ° má»¥c deployment
          mkdir -p backend-deploy

          # Copy dist output
          cp -r backend/dist backend-deploy/

          # Copy package.json (cáº§n thiáº¿t Ä‘á»ƒ biáº¿t dependencies)
          cp backend/package.json backend-deploy/

          # Copy shared dist (backend cáº§n import tá»« shared)
          mkdir -p backend-deploy/shared
          cp -r shared/dist backend-deploy/shared/
          cp shared/package.json backend-deploy/shared/

          # Táº¡o production node_modules báº±ng pnpm deploy
          cd backend
          pnpm deploy --prod ../backend-deploy/node_modules_temp
          cd ..

          # Move node_modules vÃ o Ä‘Ãºng vá»‹ trÃ­
          mv backend-deploy/node_modules_temp/node_modules backend-deploy/
          rm -rf backend-deploy/node_modules_temp

          # Táº¡o file README hÆ°á»›ng dáº«n deploy
          cat > backend-deploy/README.md << 'EOF'
          # Smart Forecast Backend Deployment

          ## CÃ¡ch sá»­ dá»¥ng

          1. Giáº£i nÃ©n file nÃ y
          2. Táº¡o file `.env` vá»›i cÃ¡c biáº¿n mÃ´i trÆ°á»ng (xem `.env.example` trong repo)
          3. Cháº¡y: `node dist/main.js`

          ## Biáº¿n mÃ´i trÆ°á»ng báº¯t buá»™c

          ```env
          NODE_ENV=production
          PORT=8000
          DATABASE_URL=postgresql://...
          JWT_SECRET=your_secret_key
          OPENWEATHERMAP_API_KEY=your_api_key
          ```

          Xem chi tiáº¿t táº¡i: https://github.com/NEU-DataVerse/Smart-Forecast
          EOF

      - name: ğŸ“¦ Create zip archive
        run: |
          cd backend-deploy
          zip -r ../backend-dist.zip .
          cd ..

      - name: ğŸ“¤ Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-dist
          path: backend-dist.zip
          retention-days: 1

  # ============================================
  # Job 3: Build Web (Next.js)
  # ============================================
  # Build Next.js vá»›i standalone output mode
  build-web:
    name: ğŸŒ Build Web
    runs-on: ubuntu-latest
    needs: build-shared
    env:
      # Sá»­ dá»¥ng secrets náº¿u cÃ³, náº¿u khÃ´ng dÃ¹ng placeholder
      # NgÆ°á»i dÃ¹ng cÃ³ thá»ƒ override khi deploy báº±ng cÃ¡ch set biáº¿n mÃ´i trÆ°á»ng
      NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || 'http://localhost:8000/api/v1' }}
      NEXT_PUBLIC_MINIO_URL: ${{ secrets.NEXT_PUBLIC_MINIO_URL || 'http://localhost:9000' }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Restore shared build cache
        uses: actions/cache/restore@v4
        with:
          path: |
            shared/dist
            node_modules
            backend/node_modules
            web/node_modules
            mobile/node_modules
            docs-site/node_modules
          key: shared-build-${{ github.sha }}

      - name: ğŸ”¨ Build web
        run: pnpm --filter web build

      - name: ğŸ“¦ Create deployment package
        run: |
          # Táº¡o thÆ° má»¥c deployment
          mkdir -p web-deploy

          # Next.js standalone output chá»©a táº¥t cáº£ cáº§n thiáº¿t Ä‘á»ƒ cháº¡y
          if [ -d "web/.next/standalone" ]; then
            cp -r web/.next/standalone/* web-deploy/
          else
            # Fallback náº¿u khÃ´ng dÃ¹ng standalone mode
            cp -r web/.next web-deploy/
            cp web/package.json web-deploy/
          fi

          # Copy static files
          if [ -d "web/.next/static" ]; then
            mkdir -p web-deploy/.next/static
            cp -r web/.next/static/* web-deploy/.next/static/
          fi

          # Copy public folder
          if [ -d "web/public" ]; then
            cp -r web/public web-deploy/
          fi

          # Copy shared dist
          mkdir -p web-deploy/shared
          cp -r shared/dist web-deploy/shared/
          cp shared/package.json web-deploy/shared/

          # Táº¡o file README hÆ°á»›ng dáº«n deploy
          cat > web-deploy/README.md << 'EOF'
          # Smart Forecast Web Deployment

          ## CÃ¡ch sá»­ dá»¥ng (Standalone Mode)

          1. Giáº£i nÃ©n file nÃ y
          2. Set biáº¿n mÃ´i trÆ°á»ng:
             ```bash
             export NEXT_PUBLIC_API_URL=https://your-api-url/api/v1
             export NEXT_PUBLIC_MINIO_URL=https://your-minio-url
             export PORT=3000
             ```
          3. Cháº¡y: `node server.js`

          ## Hoáº·c sá»­ dá»¥ng Docker

          ```dockerfile
          FROM node:20-alpine
          WORKDIR /app
          COPY . .
          ENV PORT=3000
          EXPOSE 3000
          CMD ["node", "server.js"]
          ```

          Xem chi tiáº¿t táº¡i: https://github.com/NEU-DataVerse/Smart-Forecast
          EOF

      - name: ğŸ“¦ Create zip archive
        run: |
          cd web-deploy
          zip -r ../web-dist.zip .
          cd ..

      - name: ğŸ“¤ Upload web artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: web-dist.zip
          retention-days: 1

  # ============================================
  # Job 4: Build Mobile (Expo EAS)
  # ============================================
  # Build Android APK sá»­ dá»¥ng EAS Build cloud service
  build-mobile:
    name: ğŸ“± Build Mobile
    runs-on: ubuntu-latest
    needs: build-shared
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Restore shared build cache
        uses: actions/cache/restore@v4
        with:
          path: |
            shared/dist
            node_modules
            backend/node_modules
            web/node_modules
            mobile/node_modules
            docs-site/node_modules
          key: shared-build-${{ github.sha }}

      - name: ğŸ”§ Setup EAS CLI
        run: npm install -g eas-cli

      - name: ğŸ” Login to Expo
        run: eas login --token ${{ secrets.EXPO_TOKEN }}
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“± Build Android APK (Production)
        working-directory: mobile
        run: |
          # Build APK vá»›i profile production
          # --non-interactive: khÃ´ng há»i interactive prompts
          # --wait: Ä‘á»£i build hoÃ n thÃ nh
          # --json: output dáº¡ng JSON Ä‘á»ƒ parse
          eas build \
            --platform android \
            --profile production \
            --non-interactive \
            --wait \
            --json > build-result.json 2>&1 || true

          # Kiá»ƒm tra káº¿t quáº£
          if [ -f build-result.json ]; then
            cat build-result.json
          fi

      - name: ğŸ“¥ Download APK from EAS
        working-directory: mobile
        run: |
          # Parse build URL tá»« káº¿t quáº£
          BUILD_URL=$(cat build-result.json | jq -r '.[0].artifacts.buildUrl // empty')

          if [ -z "$BUILD_URL" ]; then
            echo "âŒ KhÃ´ng tÃ¬m tháº¥y build URL. Kiá»ƒm tra build-result.json:"
            cat build-result.json
            exit 1
          fi

          echo "ğŸ“¥ Downloading APK from: $BUILD_URL"

          # Download APK
          curl -L -o smart-forecast-${{ github.ref_name }}.apk "$BUILD_URL"

          # Verify file
          ls -la smart-forecast-*.apk

      - name: ğŸ“¤ Upload mobile artifact
        uses: actions/upload-artifact@v4
        with:
          name: mobile-apk
          path: mobile/smart-forecast-*.apk
          retention-days: 1

  # ============================================
  # Job 5: Build Docs Site (Docusaurus)
  # ============================================
  # Validate docs build - khÃ´ng upload vÃ o release
  build-docs:
    name: ğŸ“š Build Docs
    runs-on: ubuntu-latest
    needs: build-shared
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Restore shared build cache
        uses: actions/cache/restore@v4
        with:
          path: |
            shared/dist
            node_modules
            backend/node_modules
            web/node_modules
            mobile/node_modules
            docs-site/node_modules
          key: shared-build-${{ github.sha }}

      - name: ğŸ”¨ Build docs site
        run: pnpm --filter @smart-forecast/docs build

      - name: âœ… Docs build successful
        run: echo "Docs site build completed successfully. Deployment is handled by docs-deploy.yml workflow."

  # ============================================
  # Job 6: Create GitHub Release
  # ============================================
  # Táº¡o GitHub Release vÃ  upload táº¥t cáº£ artifacts
  create-release:
    name: ğŸš€ Create Release
    runs-on: ubuntu-latest
    needs: [build-backend, build-web, build-mobile, build-docs]
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-dist
          path: ./release-assets

      - name: ğŸ“¥ Download web artifact
        uses: actions/download-artifact@v4
        with:
          name: web-dist
          path: ./release-assets

      - name: ğŸ“¥ Download mobile artifact
        uses: actions/download-artifact@v4
        with:
          name: mobile-apk
          path: ./release-assets

      - name: ğŸ“‹ List release assets
        run: |
          echo "ğŸ“¦ Release assets:"
          ls -la ./release-assets/

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Smart Forecast ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          generate_release_notes: true
          files: |
            ./release-assets/backend-dist.zip
            ./release-assets/web-dist.zip
            ./release-assets/smart-forecast-*.apk
          body: |
            ## ğŸ‰ Smart Forecast ${{ github.ref_name }}

            ### ğŸ“¦ Artifacts

            | File | MÃ´ táº£ |
            |------|-------|
            | `backend-dist.zip` | NestJS backend (dist + dependencies) |
            | `web-dist.zip` | Next.js web app (standalone build) |
            | `smart-forecast-*.apk` | Android APK |

            ### ğŸš€ HÆ°á»›ng dáº«n Deploy

            #### Backend
            1. Giáº£i nÃ©n `backend-dist.zip`
            2. Táº¡o file `.env` vá»›i cÃ¡c biáº¿n mÃ´i trÆ°á»ng cáº§n thiáº¿t
            3. Cháº¡y: `node dist/main.js`

            #### Web
            1. Giáº£i nÃ©n `web-dist.zip`
            2. Set biáº¿n mÃ´i trÆ°á»ng `NEXT_PUBLIC_API_URL` vÃ  `NEXT_PUBLIC_MINIO_URL`
            3. Cháº¡y: `node server.js`

            #### Mobile
            - CÃ i Ä‘áº·t trá»±c tiáº¿p file APK trÃªn thiáº¿t bá»‹ Android

            ğŸ“– Xem chi tiáº¿t táº¡i [Deployment Guide](https://github.com/NEU-DataVerse/Smart-Forecast/blob/main/docs-site/docs/deployment.md)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
